name: "Reth Benchmark"

on:
  workflow_dispatch:
    inputs:
      # Default runner is not big enough for this
      # https://aws.amazon.com/ec2/instance-types/
      instance_cpu:
        type: string
        required: false
        description: The number of CPUs of the instance to start
        default: 64
      instance_ram:
        type: string
        required: false
        description: The number of CPUs of the instance to start
        default: 256
      instance_family:
        type: string
        required: false
        description: The family of the instance, can be multiple ones concat with "+" e.g. r8g+r7g
        default: m7
      memory_allocator:
        type: string
        required: false
        description: Memory allocator to use (mimalloc or jemalloc)
        default: mimalloc
      app_log_blowup:
        type: number
        required: false
        description: Application level log blowup
        default: 2
      agg_log_blowup:
        type: number
        required: false
        description: Aggregation (leaf) level log blowup
        default: 2
      root_log_blowup:
        type: number
        required: false
        description: Root level log blowup (only for e2e)
        default: 2
      internal_log_blowup:
        type: number
        required: false
        description: Internal level log blowup (only for e2e)
        default: 2

env:
  S3_PATH: s3://axiom-workflow-data-sandbox-us-east-1/benchmark/github/results
  S3_METRICS_PATH: s3://axiom-workflow-data-sandbox-us-east-1/benchmark/github/metrics
  PUBLIC_S3_PATH: s3://axiom-public-data-sandbox-us-east-1/benchmark/github/flamegraphs
  FEATURE_FLAGS: "bench-metrics,parallel,nightly-features"
  CMD_ARGS: ""
  INPUT_ARGS: ""
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"

jobs:
  run-reth:
    name: Run Reth benchmark
    runs-on:
      - runs-on
      - run-id=${{ github.run_id }}
      - cpu=${{ inputs.instance_cpu }}
      - ram=${{ inputs.instance_ram }}
      - family=${{ inputs.instance_family }}
      - tag=bench-reth-${{ github.run_id }}-${{ github.run_number }}-${{ github.run_attempt }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
      - name: Give GitHub Actions access to axiom-crypto github org
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.GH_ACTIONS_DEPLOY_PRIVATE_KEY }}
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - name: Setup halo2
        run: |
          bash extensions/native/recursion/trusted_setup_s3.sh
      - name: Setup CLI
        working-directory: crates/cargo-axiom
        run: |
          cargo install --force --path .
      - name: Checkout Reth. This is inside afs-prototype dir but it's fine.
        run: |
          git clone git@github.com:axiom-crypto/rsp.git
      - name: Run Reth
        run: |
          cd rsp
          cargo run --release --features=bench-metrics,parallel,nightly-features -- --log-level=debug --log-blowup=${{ inputs.app_log_blowup }} --agg-log-blowup=${{ inputs.agg_log_blowup }} --root-log-blowup=${{ inputs.root_log_blowup }} --internal-log-blowup=${{ inputs.internal_log_blowup }}
