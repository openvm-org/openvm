name: "Reth Benchmark"

on:
  workflow_dispatch:
    inputs:
      # Default runner is not big enough for this
      # https://aws.amazon.com/ec2/instance-types/
      instance_cpu:
        type: string
        required: false
        description: The number of CPUs of the instance to start
        default: "64"
      instance_ram:
        type: string
        required: false
        description: The RAM of the instance to start
        default: "256"
      instance_family:
        type: string
        required: false
        description: The family of the instance, can be multiple ones concat with "+" e.g. r8g+r7g
        default: m7
      memory_allocator:
        type: string
        required: false
        description: Memory allocator to use (mimalloc or jemalloc)
        default: mimalloc
      app_log_blowup:
        type: number
        required: false
        description: Application level log blowup
        default: 2
      agg_log_blowup:
        type: number
        required: false
        description: Aggregation (leaf) level log blowup
        default: 2
      root_log_blowup:
        type: number
        required: false
        description: Root level log blowup (only for e2e)
        default: 2
      # TODO: sadly workflow dispatch can only support 10 inputs. Find a workaround.
      # internal_log_blowup:
      #   type: number
      #   required: false
      #   description: Internal level log blowup (only for e2e)
      #   default: 2
      mode:
        type: string
        required: false
        description: Running mode, one of execute, prove, or prove-e2e
        default: prove
      # TODO: store a github secret for this
      rpc_url:
        type: string
        required: true
        description: RPC URL to use
      # TODO: sadly workflow dispatch can only support 10 inputs. Find a workaround.
      # collect_metrics:
      #   type: boolean
      #   required: false
      #   description: Whether to collect metrics for flamegraphs
      #   default: false
      # max_segment_length:
      #   type: number
      #   required: false
      #   description: Max segment length for continuations, must be larger than 524288
      #   default: 1048476

env:
  S3_PATH: s3://axiom-workflow-data-sandbox-us-east-1/benchmark/github/results
  S3_METRICS_PATH: s3://axiom-workflow-data-sandbox-us-east-1/benchmark/github/metrics
  PUBLIC_S3_PATH: s3://axiom-public-data-sandbox-us-east-1/benchmark/github/flamegraphs
  FEATURE_FLAGS: "bench-metrics,parallel,nightly-features"
  CMD_ARGS: ""
  INPUT_ARGS: ""
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"

jobs:
  run-reth:
    name: Run Reth benchmark
    runs-on:
      - runs-on
      - run-id=${{ github.run_id }}
      - cpu=${{ inputs.instance_cpu }}
      - ram=${{ inputs.instance_ram }}
      - family=${{ inputs.instance_family }}
      - disk=large
      - tag=bench-reth-${{ github.run_id }}-${{ github.run_number }}-${{ github.run_attempt }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
      - name: Give GitHub Actions access to axiom-crypto github org
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.GH_ACTIONS_DEPLOY_PRIVATE_KEY }}
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - name: Setup CLI
        working-directory: crates/cargo-axiom
        run: |
          cargo install --force --path .
      - name: Install architecture specific tools
        run: |
          arch=$(uname -m)
          case $arch in
            arm64|aarch64)
              rustup component add rust-src --toolchain nightly-2024-10-30-aarch64-unknown-linux-gnu
              S5CMD_BIN="s5cmd_2.2.2_linux_arm64.deb"
              ;;
            x86_64|amd64)
              rustup component add rust-src --toolchain nightly-2024-10-30-x86_64-unknown-linux-gnu
              S5CMD_BIN="s5cmd_2.2.2_linux_amd64.deb"
              ;;
            *)
              echo "Unsupported architecture: $arch"
              exit 1
              ;;
          esac

          echo "Checking s5cmd"
          if type s5cmd &>/dev/null; then
              echo "s5cmd was installed."
          else
              TMP_DIR=/tmp/s5cmd
              rm -rf $TMP_DIR
              mkdir $TMP_DIR
              echo "s5cmd was not installed. Installing.."
              wget "https://github.com/peak/s5cmd/releases/download/v2.2.2/${S5CMD_BIN}" -P $TMP_DIR
              sudo dpkg -i "${TMP_DIR}/${S5CMD_BIN}"
          fi

      - name: Checkout Reth. This is inside afs-prototype dir but it's fine.
        run: |
          git clone git@github.com:axiom-crypto/rsp.git

      - name: Setup halo2
        if: ${{ github.event.inputs.mode == 'prove-e2e' }}
        run: |
          bash ./extensions/native/recursion/trusted_setup_s3.sh
          ln -s params rsp/params
      
      - name: Set metric name
        run: |
          source ci/scripts/utils.sh
          METRIC_NAME=$(get_metric_name ${{ env.E2E_BENCH }} ${{ env.BIN_NAME }} ${{ inputs.app_log_blowup }} ${{ inputs.agg_log_blowup }} ${{ inputs.root_log_blowup }} ${{ inputs.internal_log_blowup }} ${{ inputs.max_segment_length }} ${{ inputs.instance_type }} ${{ inputs.memory_allocator }})
          echo "METRIC_NAME=${METRIC_NAME}" >> $GITHUB_ENV
          METRIC_PATH=".bench_metrics/${METRIC_NAME}.json"
          echo "METRIC_PATH=${METRIC_PATH}" >> $GITHUB_ENV

      - name: Run Reth
        run: |
          cd rsp/bin/client-eth
          cargo axiom build
          mkdir -p ../host/elf
          cp target/riscv32im-risc0-zkvm-elf/release/rsp-client-eth ../host/elf/
          cd ../..
          mkdir -p rpc-cache
          export RPC_1=${{ inputs.rpc_url }}
          export MODE=${{ inputs.mode }}
          cargo build --bin rsp --release
          OUTPUT_PATH=metrics.json RUSTFLAGS="-Ctarget-cpu=native" ./target/release/rsp --$MODE --block-number 20526624 --rpc-url $RPC_1 --cache-dir rpc-cache
          cp metrics.json ${METRIC_PATH}

      - name: Upload Benchmark Metrics
        working-directory: rsp
        run: |
          current_sha=$(git rev-parse HEAD)
          s5cmd cp ${METRIC_PATH} ${{ env.S3_METRICS_PATH }}/${current_sha}-${METRIC_NAME}.json
      
      - name: Store metric json and compute diff with previous
        run: |
          current_sha=$(git rev-parse HEAD)
          echo "Current SHA: $current_sha"
          echo "current_sha=${current_sha}" >> $GITHUB_ENV

          source ci/scripts/utils.sh
          generate_markdown $METRIC_PATH $METRIC_NAME $current_sha ${{ env.S3_METRICS_PATH }}

      - name: Install inferno-flamegraph
        run: cargo install inferno

      - name: Generate flamegraphs
        run: |
          if [[ -f $METRIC_PATH ]]; then
            python3 ci/scripts/metric_unify/flamegraph.py $METRIC_PATH
            s5cmd cp '.bench_metrics/flamegraphs/*.svg' "${{ env.PUBLIC_S3_PATH }}/${current_sha}/"
            echo "UPLOAD_FLAMEGRAPHS=1" >> $GITHUB_ENV
          fi

      - name: Add benchmark metadata
        run: |
          source ci/scripts/utils.sh
          add_metadata results.md ${{ inputs.max_segment_length }} ${{ inputs.instance_type }} ${{ inputs.memory_allocator }} ${{ github.repository }} ${{ github.run_id }}
