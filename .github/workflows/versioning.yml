# Workflow to verify versioning compatibility between main and patch versions
name: Verify Versioning Compatibility

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to compare against main (e.g., v1.2.0)"
        required: true
        default: "v1.2.0"
        type: string
  push:

jobs:
  verify-versioning:
    runs-on:
      - runs-on=${{ github.run_id }}
      - runner=64cpu-linux-arm64
      - extras=s3-cache
    steps:
      - name: Set version fallback
        run: echo "version=${{ github.event.inputs.version || 'v1.2.0' }}" >> $GITHUB_ENV

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install solc # svm should support arm64 linux
        run: (hash svm 2>/dev/null || cargo install --version 0.2.23 svm-rs) && svm install 0.8.19 && solc --version

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2

      # Build and test from main
      - name: Build main CLI
        run: cargo install --force --path crates/cli

      - name: Run setup from main and snapshot ~/.openvm
        run: |
          cargo openvm setup
          rm -rf ~/.openvm-main
          mv ~/.openvm ~/.openvm-main

      - name: Build and keygen examples from main
        run: |
          mkdir -p ./main-outputs/examples
          for example in examples/*/; do
            if [ -f "$example/Cargo.toml" ]; then
              example_name=$(basename "$example")
              echo "Building and generating keys for example: $example_name"
              cd "$example"
              cargo openvm build
              cargo openvm keygen --output-dir "../../main-outputs/examples/$example_name"
              cd ../..
            fi
          done

      - name: Build and keygen benchmarks from main
        run: |
          mkdir -p ./main-outputs/benchmarks
          for benchmark in benchmarks/guest/*/; do
            if [ -f "$benchmark/Cargo.toml" ]; then
              benchmark_name=$(basename "$benchmark")
              echo "Building and generating keys for benchmark: $benchmark_name"
              cd "$benchmark"
              cargo openvm build
              cargo openvm keygen --output-dir "../../../main-outputs/benchmarks/$benchmark_name"
              cd ../../..
            fi
          done

      # Checkout and test tagged version
      - name: Checkout tagged version
        uses: actions/checkout@v4
        with:
          ref: ${{ env.version }}
          clean: false

      - name: Build tagged CLI
        run: cargo install --force --path crates/cli

      - name: Run setup from tagged version
        run: |
          cargo openvm setup

      - name: Build and keygen examples from tagged version
        run: |
          mkdir -p ./tagged-outputs/examples
          for example in examples/*/; do
            if [ -f "$example/Cargo.toml" ]; then
              example_name=$(basename "$example")
              echo "Building and generating keys for example: $example_name"
              cd "$example"
              cargo openvm build
              # TODO(yi): Change --vk-output to --output-dir after v1.3.0 release
              mkdir -p "../../tagged-outputs/examples/$example_name"
              cargo openvm keygen --vk-output "../../tagged-outputs/examples/$example_name/app.vk"
              cd ../..
            fi
          done

      - name: Build and keygen benchmarks from tagged version
        run: |
          mkdir -p ./tagged-outputs/benchmarks
          for benchmark in benchmarks/guest/*/; do
            if [ -f "$benchmark/Cargo.toml" ]; then
              benchmark_name=$(basename "$benchmark")
              echo "Building and generating keys for benchmark: $benchmark_name"
              cd "$benchmark"
              cargo openvm build
              # TODO(yi): Change --vk-output to --output-dir after v1.3.0 release
              mkdir -p "../../../tagged-outputs/benchmarks/$benchmark_name"
              cargo openvm keygen --vk-output "../../../tagged-outputs/benchmarks/$benchmark_name/app.vk"
              cd ../../..
            fi
          done

      # Compare all outputs
      - name: Compare ~/.openvm contents
        run: |
          echo "Comparing ~/.openvm between main and ${{ env.version }}..."
          if diff -r ~/.openvm-main ~/.openvm; then
            echo "‚úÖ ~/.openvm outputs are identical"
          else
            echo "‚ùå ~/.openvm outputs differ"
            exit 1
          fi

      - name: Compare example verification keys
        run: |
          echo "Comparing example verification keys between main and ${{ env.version }}..."
          failed=0
          for example in examples/*/; do
            if [ -f "$example/Cargo.toml" ]; then
              example_name=$(basename "$example")
              echo "Checking example: $example_name"
              if cmp "./main-outputs/examples/$example_name/app.vk" "./tagged-outputs/examples/$example_name/app.vk"; then
                echo "‚úÖ $example_name verification keys are identical"
              else
                echo "‚ùå $example_name verification keys differ"
                failed=1
              fi
            fi
          done
          if [ $failed -eq 1 ]; then
            echo "‚ùå Some example verification keys differ - versioning policy violated"
            exit 1
          else
            echo "‚úÖ All example verification keys are identical"
          fi

      - name: Compare benchmark verification keys
        run: |
          echo "Comparing benchmark verification keys between main and ${{ env.version }}..."
          failed=0
          for benchmark in benchmarks/guest/*/; do
            if [ -f "$benchmark/Cargo.toml" ]; then
              benchmark_name=$(basename "$benchmark")
              echo "Checking benchmark: $benchmark_name"
              if cmp "./main-outputs/benchmarks/$benchmark_name/app.vk" "./tagged-outputs/benchmarks/$benchmark_name/app.vk"; then
                echo "‚úÖ $benchmark_name verification keys are identical"
              else
                echo "‚ùå $benchmark_name verification keys differ"
                failed=1
              fi
            fi
          done
          if [ $failed -eq 1 ]; then
            echo "‚ùå Some benchmark verification keys differ - versioning policy violated"
            exit 1
          else
            echo "‚úÖ All benchmark verification keys are identical"
          fi

      - name: Final summary
        run: |
          echo "üéâ Versioning compatibility verification completed successfully!"
          echo "‚úÖ Setup outputs are identical between main and ${{ env.version }}"
          echo "‚úÖ All example verification keys are identical"
          echo "‚úÖ All benchmark verification keys are identical"
          echo "‚úÖ Versioning policy maintained - patch upgrade is backward compatible"
