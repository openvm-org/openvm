name: axVM Benchmarks

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: ["**"]
    paths:
      - "stark-backend/**"
      - "stark-sdk/**"
      - "circuits/**"
      - "vm/**"
      - "toolchain/**"
      - "lib/recursion/**"
      - "benchmarks/**"
      - ".github/workflows/benchmark-call.yml"
      - ".github/workflows/benchmarks.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  AXIOM_FAST_TEST: "1"

jobs:
  create-matrix:
    runs-on:
      - runs-on=${{ github.run_id }}
      - runner=8cpu-linux-x64
    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}

      - name: Create benchmark matrix from JSON
        id: create-matrix
        run: |
          if [ ! -f ./.github/workflows/benchmark-config.json ]; then
            echo "Error: ./.github/workflows/benchmark-config.json not found"
            exit 1
          fi
          matrix=$(jq -c '
            [
              .benchmarks[] | 
              .name as $name |
              .run_params[] | 
              {name: $name, app_log_blowup: .app_log_blowup, agg_log_blowup: .agg_log_blowup}
            ]
          ' ./.github/workflows/benchmark-config.json)
          if [ $? -ne 0 ]; then
            echo "Error: Failed to parse ./.github/workflows/benchmark-config.json"
            exit 1
          fi
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  benchmark:
    needs: create-matrix
    strategy:
      matrix:
        benchmark_run: ${{fromJson(needs.create-matrix.outputs.matrix)}}
    uses: ./.github/workflows/benchmark-call.yml
    with:
      benchmark_name: ${{ matrix.benchmark_run.name }}
      app_log_blowup: ${{ matrix.benchmark_run.app_log_blowup }}
      agg_log_blowup: ${{ matrix.benchmark_run.agg_log_blowup }}
    secrets: inherit
