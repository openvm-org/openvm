# openvm-continuations

Basic provers for the continuation aggregation pipeline. Each basic prover generates a single aggregated `Proof` from child `Proof`s for a specific aggregation subcircuit (i.e. **nonroot**, **compression**, and **root**).

For the full specification (layer architecture, subcircuit constraints, public value layouts), see the [continuations spec](../../docs/vocs/docs/pages/specs/architecture/continuations.mdx).

## Nonroot Basic Prover

Used for the **leaf**, **internal-for-leaf**, and **internal-recursive** layers, which all share the nonroot aggregation subcircuit.

### Constructor

```rust
pub fn new(
    child_vk: Arc<MultiStarkVerifyingKey<SC>>,
    system_params: SystemParams,
    is_self_recursive: bool,
) -> Self
```

- `child_vk` — verifying key for child proofs
- `system_params` — parent system parameters
- `self_recursion_enabled` — indicates whether this prover is internal-recursive (i.e., can use its own `vk` as `child_vk`)

Constructing the prover pre-generates the child layer's **cached trace commit** and the parent layer's proving and verifying keys. Functions to construct the prover from a saved `pk` and cached trace are available.

Each nonroot layer should use the following constructor arguments:

| Layer | `child_vk` | `system_params` | `self_recursion_enabled` |
|-------|-----------------|------------------|-------|
| leaf | `app_vk` | leaf | false |
| internal-for-leaf | `leaf_vk` | internal | false |
| internal-recursive | `internal_for_leaf_vk` | internal | true |

Note that internal-for-leaf and internal-recursive share the same system parameters, and that there is only one internal-recursive prover.

### Prove API

```rust
pub fn agg_prove(
    &self,
    proofs: &[Proof<SC>],
    child_vk_kind: ChildVkKind,
) -> Result
```

- `proofs` — child `Proof`s to aggregate
- `child_vk_kind` — enum that indicates whether the child proofs are from the app layer (`App`), the same layer recursively (`Recursive`), or a different layer (`Standard`)

Each layer uses the following inputs:

| Layer | `proofs` | `child_vk_kind` |
|-------|-----------------|------------------|
| leaf | app proofs | `App` |
| internal-for-leaf | leaf proofs | `Standard` |
| internal-recursive (layer 0) | internal-for-leaf proofs | `Standard` |
| internal-recursive (layer 1+) | internal-recursive proofs | `Recursive` |

## Compression Basic Prover

Used for the **compression** layer, which wraps a single internal-recursive `Proof` without a cached trace.

### Constructor

```rust
pub fn new(
    child_vk: Arc<MultiStarkVerifyingKey<SC>>,
    child_vk_pcs_data: CommittedTraceData<PB>,
    system_params: SystemParams,
) -> Self
```

- `child_vk` — reference to the `internal_recursive_vk`
- `child_vk_pcs_data` — committed trace data for the child's (internal-recursive) cached trace, generated by the nonroot prover
- `system_params` — parent system parameters

The constructor pre-generates the in-circuit DAG commit metadata and the parent proving and verifying keys. Functions to load and save this pre-generation work are available.

### Prove API

```rust
pub fn compress_prove(
    &self,
    proof: Proof<SC>,
) -> Result
```

Once the prover is constructed, wrapping an internal-recursive `Proof` requires only a reference to it.

## Root Basic Prover

Used for the **root** layer, which wraps a single internal-recursive `Proof` and constrains user public values' presence in memory.

### Constructor

```rust
pub fn new(
    child_vk: Arc<MultiStarkVerifyingKey<SC>>,
    child_vk_pcs_data: CommittedTraceData<PB>,
    system_params: SystemParams,
    memory_dimensions: MemoryDimensions,
    num_user_pvs: usize,
    trace_heights: Option<Vec<usize>>,
) -> Self
```

- `child_vk` — the `internal_recursive_vk`
- `child_vk_pcs_data` — committed trace data for the child's (internal-recursive) cached trace, generated by the nonroot prover
- `system_params` — parent system parameters
- `num_user_pvs` — number of user public values
- `memory_dimensions` — the memory dimensions used for app execution, used to compute whether each sibling hash in the Merkle proof should be the left or right sibling
- `trace_heights` - constant heights that the traces of the root proof must be

The constructor pre-generates the parent proving and verifying keys, which can be saved.

### Prove API

```rust
pub fn root_prove(
    &self,
    proof: Proof<SC>,
    user_pvs_proof: &UserPublicValuesProof<DIGEST_SIZE, PB::Val>,
) -> Result
```

- `proof` — reference to the child internal-recursive `Proof`
- `user_pvs_proof` — the user public values Merkle proof (proving presence in memory); generated at the app layer